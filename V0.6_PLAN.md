# V0.6 Implementation Plan: Groups Foundation

## Overview

Add the ability to create groups and manage members. This is the foundation for V0.9's group calendar feature.

---

## Pre-Implementation Checklist (per CLAUDE.md)

### 1. Where is the single source of truth?
- **Groups**: `groups` table
- **Membership**: `group_members` table
- **Add member**: `add_group_member` RPC function (atomic, with error codes)

### 2. What are the exact result codes?

**Create Group:**
- `SUCCESS` - Group created
- `INVALID_NAME` - Name too short/long (3-30 chars)
- `UNAUTHORIZED` - Not logged in
- `UNKNOWN_ERROR` - Unexpected failure

**Add Member:**
- `SUCCESS` - Member added
- `USER_NOT_FOUND` - Username doesn't exist
- `ALREADY_MEMBER` - User is already in group
- `GROUP_NOT_FOUND` - Group doesn't exist
- `NOT_OWNER` - Only creator can add members
- `GROUP_FULL` - Max 20 members reached
- `CANNOT_ADD_SELF` - Creator is auto-added, can't re-add
- `UNAUTHORIZED` - Not logged in
- `UNKNOWN_ERROR` - Unexpected failure

**Remove Member:**
- `SUCCESS` - Member removed
- `NOT_OWNER` - Only creator can remove members
- `CANNOT_REMOVE_SELF` - Creator cannot leave (must delete group)
- `MEMBER_NOT_FOUND` - User not in group
- `UNAUTHORIZED` - Not logged in
- `UNKNOWN_ERROR` - Unexpected failure

### 3. Can this operation partially succeed?
- **Create group**: No - single insert
- **Add member**: No - single insert via RPC
- **Remove member**: No - single delete

### 4. What happens if two users act simultaneously?
- **Add same member twice**: DB unique constraint prevents duplicates, RPC returns `ALREADY_MEMBER`
- **Remove while adding**: One succeeds, other gets appropriate error

### 5. How does the UI know the operation succeeded?
- All mutations return result codes
- UI refetches from DB after success (no state guessing)

### 6. What logic will be deleted to prevent duplication?
- N/A - new feature, no existing code

---

## Implementation Order

### Phase 1: Database (006_add_groups.sql)

```sql
-- Tables
CREATE TABLE groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  created_by UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  CONSTRAINT group_name_length CHECK (char_length(name) BETWEEN 3 AND 30)
);

CREATE TABLE group_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  group_id UUID NOT NULL REFERENCES groups(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(group_id, user_id)
);

-- Indexes
CREATE INDEX idx_groups_created_by ON groups(created_by);
CREATE INDEX idx_group_members_group ON group_members(group_id);
CREATE INDEX idx_group_members_user ON group_members(user_id);

-- RLS
ALTER TABLE groups ENABLE ROW LEVEL SECURITY;
ALTER TABLE group_members ENABLE ROW LEVEL SECURITY;

-- Policies for groups
CREATE POLICY "Users can view groups they belong to"
  ON groups FOR SELECT
  USING (
    id IN (SELECT group_id FROM group_members WHERE user_id = auth.uid())
    OR created_by = auth.uid()
  );

CREATE POLICY "Users can create groups"
  ON groups FOR INSERT
  WITH CHECK (created_by = auth.uid());

CREATE POLICY "Creators can delete their groups"
  ON groups FOR DELETE
  USING (created_by = auth.uid());

-- Policies for group_members
CREATE POLICY "Members can view group members"
  ON group_members FOR SELECT
  USING (
    group_id IN (SELECT group_id FROM group_members WHERE user_id = auth.uid())
  );

CREATE POLICY "Creators can manage members"
  ON group_members FOR ALL
  USING (
    group_id IN (SELECT id FROM groups WHERE created_by = auth.uid())
  );

-- RPC: add_group_member
CREATE OR REPLACE FUNCTION add_group_member(p_group_id UUID, member_username TEXT)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_member_id UUID;
  v_current_user_id UUID;
  v_group_owner_id UUID;
  v_member_count INTEGER;
BEGIN
  v_current_user_id := auth.uid();

  IF v_current_user_id IS NULL THEN
    RETURN '{"code": "UNAUTHORIZED"}'::JSON;
  END IF;

  -- Get group owner
  SELECT created_by INTO v_group_owner_id FROM groups WHERE id = p_group_id;

  IF v_group_owner_id IS NULL THEN
    RETURN '{"code": "GROUP_NOT_FOUND"}'::JSON;
  END IF;

  IF v_group_owner_id != v_current_user_id THEN
    RETURN '{"code": "NOT_OWNER"}'::JSON;
  END IF;

  -- Find member by username
  SELECT id INTO v_member_id FROM profiles WHERE lower(username) = lower(trim(member_username));

  IF v_member_id IS NULL THEN
    RETURN '{"code": "USER_NOT_FOUND"}'::JSON;
  END IF;

  -- Check if already member
  IF EXISTS (SELECT 1 FROM group_members WHERE group_id = p_group_id AND user_id = v_member_id) THEN
    RETURN '{"code": "ALREADY_MEMBER"}'::JSON;
  END IF;

  -- Check member count
  SELECT COUNT(*) INTO v_member_count FROM group_members WHERE group_id = p_group_id;
  IF v_member_count >= 20 THEN
    RETURN '{"code": "GROUP_FULL"}'::JSON;
  END IF;

  -- Insert member
  INSERT INTO group_members (group_id, user_id) VALUES (p_group_id, v_member_id);

  RETURN json_build_object('code', 'SUCCESS', 'member_id', v_member_id);

EXCEPTION
  WHEN unique_violation THEN
    RETURN '{"code": "ALREADY_MEMBER"}'::JSON;
  WHEN OTHERS THEN
    RETURN json_build_object('code', 'UNKNOWN_ERROR', 'detail', SQLERRM);
END;
$$;

-- Trigger: Auto-add creator as member when group is created
CREATE OR REPLACE FUNCTION auto_add_creator_to_group()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO group_members (group_id, user_id) VALUES (NEW.id, NEW.created_by);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER add_creator_on_group_create
  AFTER INSERT ON groups
  FOR EACH ROW
  EXECUTE FUNCTION auto_add_creator_to_group();

GRANT EXECUTE ON FUNCTION add_group_member(UUID, TEXT) TO authenticated;
```

### Phase 2: Types (src/types/group.ts)

```typescript
export interface Group {
  id: string;
  name: string;
  created_by: string;
  created_at: string;
  member_count?: number; // Derived
  is_owner?: boolean;    // Derived
}

export interface GroupMember {
  id: string;
  group_id: string;
  user_id: string;
  joined_at: string;
  // Joined from profiles:
  username: string;
  display_name: string | null;
  avatar_type: string;
  avatar_color: string;
}

export type CreateGroupCode =
  | 'SUCCESS'
  | 'INVALID_NAME'
  | 'UNAUTHORIZED'
  | 'UNKNOWN_ERROR';

export type AddMemberCode =
  | 'SUCCESS'
  | 'USER_NOT_FOUND'
  | 'ALREADY_MEMBER'
  | 'GROUP_NOT_FOUND'
  | 'NOT_OWNER'
  | 'GROUP_FULL'
  | 'UNAUTHORIZED'
  | 'UNKNOWN_ERROR';

export type RemoveMemberCode =
  | 'SUCCESS'
  | 'NOT_OWNER'
  | 'CANNOT_REMOVE_SELF'
  | 'MEMBER_NOT_FOUND'
  | 'UNAUTHORIZED'
  | 'UNKNOWN_ERROR';

export interface CreateGroupResult {
  success: boolean;
  code: CreateGroupCode;
  group?: Group;
  error?: string;
}

export interface AddMemberResult {
  success: boolean;
  code: AddMemberCode;
  error?: string;
}

export interface RemoveMemberResult {
  success: boolean;
  code: RemoveMemberCode;
  error?: string;
}
```

### Phase 3: Hooks

**useGroups.ts** - List groups, create group, delete group
**useGroupMembers.ts** - List members, add member, remove member

### Phase 4: Components

1. `GroupsPage.tsx` - List user's groups + create form
2. `GroupDetailPage.tsx` - View/manage single group
3. `CreateGroupForm.tsx` - Name input + submit
4. `GroupCard.tsx` - Display group in list
5. `GroupMembersList.tsx` - List members with avatars
6. `AddMemberForm.tsx` - Username input + submit

### Phase 5: Navigation

- Add "Groups" link to HomePage header
- Add route `/groups` and `/groups/:id`

---

## File Creation Order

1. `supabase/migrations/006_add_groups.sql`
2. `src/types/group.ts`
3. `src/hooks/useGroups.ts`
4. `src/hooks/useGroupMembers.ts`
5. `src/components/CreateGroupForm.tsx`
6. `src/components/GroupCard.tsx`
7. `src/components/GroupMembersList.tsx`
8. `src/components/AddMemberForm.tsx`
9. `src/pages/GroupsPage.tsx`
10. `src/pages/GroupDetailPage.tsx`
11. Update `src/App.tsx` - Add routes
12. Update `src/pages/HomePage.tsx` - Add nav link

---

## Testing Checklist

- [ ] Create group with valid name (3-30 chars)
- [ ] Create group with invalid name (< 3 or > 30 chars) - should fail
- [ ] Creator is auto-added as member
- [ ] Add member by username
- [ ] Add member with invalid username - should fail
- [ ] Add duplicate member - should fail with ALREADY_MEMBER
- [ ] Non-owner tries to add member - should fail with NOT_OWNER
- [ ] Add 20th member - should succeed
- [ ] Add 21st member - should fail with GROUP_FULL
- [ ] Remove member (as owner)
- [ ] Non-owner tries to remove - should fail
- [ ] Delete group (as owner)
- [ ] RLS: User can only see groups they belong to
